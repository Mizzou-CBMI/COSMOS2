

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>10. Advanced &mdash; Cosmos 2.9.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="11. Glossary" href="glossary.html" />
    <link rel="prev" title="9. FAQ" href="faq.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Cosmos
          

          
          </a>

          
            
            
              <div class="version">
                2.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_install.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_getting_started.html">3. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows/initializing.html">4. Initializing</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows/task_func.html">5. Task Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows/workflows.html">6. Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">7. Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">8. Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">9. FAQ</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. Advanced</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#args-to-str">10.1. args_to_str</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bash-call">10.2. Bash Call</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-signals">10.3. Using signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sge-signals">10.4. SGE Signals</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">11. Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Cosmos</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>10. Advanced</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/advanced.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced">
<h1>10. Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h1>
<div class="section" id="args-to-str">
<h2>10.1. args_to_str<a class="headerlink" href="#args-to-str" title="Permalink to this headline">¶</a></h2>
<p>This is a useful helper function for converting Task function arguments to command line arguments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cosmos.api</span> <span class="kn">import</span> <span class="n">args_to_str</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">in_tsv</span><span class="p">,</span> <span class="n">out_tsv</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;foo {in_tsv} {out_tsv} {args}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">args</span><span class="o">=</span><span class="n">args_to_str</span><span class="p">((</span><span class="s1">&#39;--bar&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;--x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span> <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
    <span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="cosmos.api.args_to_str">
<code class="sig-prename descclassname">cosmos.api.</code><code class="sig-name descname">args_to_str</code><span class="sig-paren">(</span><em class="sig-param">*args</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/cosmos/api.html#args_to_str"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#cosmos.api.args_to_str" title="Permalink to this definition">¶</a></dt>
<dd><p>Turn a set of arguments into a string to be passed to a command line tool</p>
<p>If value is None or False it will be ignored.
If value is True, emit –{arg_flag} without specifing a value.
Otherwise emit –{arg_flag} {value}.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>args</strong> – An iterable of (str arg_flag, value) tuples.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">z</span> <span class="o">=</span> <span class="mi">123</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">args_to_str</span><span class="p">((</span><span class="s1">&#39;--foo&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="go">&#39;--foo bar&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">args_to_str</span><span class="p">((</span><span class="s1">&#39;--flag&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="go">&#39;--flag&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">args_to_str</span><span class="p">((</span><span class="s1">&#39;--skip-me&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;--use-me&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
<span class="go">&#39;--use-me 123&#39;</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="bash-call">
<h2>10.2. Bash Call<a class="headerlink" href="#bash-call" title="Permalink to this headline">¶</a></h2>
<p>Tired of writing argparse boiler plate code for every Task you wrote a python script for?
You can use this decorator to avoid writing both argparse code, and avoid writing the Task function that returns
the bash command to call your script.  Notice how in this example, the code in <code class="xref py py-func docutils literal notranslate"><span class="pre">stats_summary()</span></code> is not returning a string which then calls another script.
The <a class="reference internal" href="#cosmos.api.bash_call" title="cosmos.api.bash_call"><code class="xref py py-func docutils literal notranslate"><span class="pre">cosmos.api.bash_call()</span></code></a> decorator does that for you automatically!  It’s a bit to wrap your head around at first, but once it clicks you’ll love it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stats_summary</span><span class="p">(</span><span class="n">in_tsv</span><span class="p">,</span> <span class="n">out_tsv</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_tsv</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_tsv</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">fp</span><span class="p">,</span> <span class="n">count</span>

<span class="n">workflow</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">bash_call</span><span class="p">(</span><span class="n">stats_summary</span><span class="p">),</span> <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">in_tsv</span><span class="o">=</span><span class="s1">&#39;in_tsv&#39;</span><span class="p">,</span><span class="n">out_tsv</span><span class="o">=</span><span class="s1">&#39;out_tsv&#39;</span><span class="p">),</span> <span class="n">uid</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="cosmos.api.bash_call">
<code class="sig-prename descclassname">cosmos.api.</code><code class="sig-name descname">bash_call</code><span class="sig-paren">(</span><em class="sig-param">func</em>, <em class="sig-param">*args</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/cosmos/api.html#bash_call"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#cosmos.api.bash_call" title="Permalink to this definition">¶</a></dt>
<dd><p>A function decorator which provides a way to avoid writing boilerplate argparse code when defining a Task.
It converts the decorated function to produce a bash script that uses python to import the function and
call it with the same arguments.</p>
<dl class="simple">
<dt>Current Limitations:</dt><dd><ul class="simple">
<li><p>Function must be importable</p></li>
<li><p>No partials</p></li>
</ul>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s1">&#39;out.txt&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fp</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">bash_call</span><span class="p">(</span><span class="n">echo</span><span class="p">)(</span><span class="n">arg1</span><span class="o">=</span><span class="s1">&#39;hello world&#39;</span><span class="p">))</span>

<span class="go">python - &lt;&lt;EOF</span>

<span class="go">try:</span>
<span class="go">    from cosmos.api import echo</span>
<span class="go">except ImportError:</span>
<span class="go">    import imp</span>
<span class="go">    echo = imp.load_source(&#39;echo&#39;, &#39;None&#39;).echo</span>

<span class="go">echo(**</span>
<span class="go">{&#39;arg1&#39;: &#39;hello world&#39;,</span>
<span class="go"> &#39;out_file&#39;: &#39;out.txt&#39;}</span>
<span class="go">)</span>

<span class="go">EOF</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="using-signals">
<h2>10.3. Using signals<a class="headerlink" href="#using-signals" title="Permalink to this headline">¶</a></h2>
<p>COSMOS uses <a class="reference external" href="https://pythonhosted.org/blinker/">blinker</a> for signals.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cosmos.api</span> <span class="kn">import</span> <span class="n">TaskStatus</span><span class="p">,</span> <span class="n">signal_task_status_change</span>

<span class="nd">@signal_task_status_change.connect</span>
<span class="k">def</span> <span class="nf">task_status_changed</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">successful</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MyStage&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">output_map</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">):</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="sge-signals">
<h2>10.4. SGE Signals<a class="headerlink" href="#sge-signals" title="Permalink to this headline">¶</a></h2>
<p>A useful context manager is available to cleanly handle SGE signals provided by <cite>qsub -notify</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cosmos.util.signal_handlers</span> <span class="kn">import</span> <span class="n">SGESignalHandler</span><span class="p">,</span> <span class="n">handle_sge_signals</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">handle_sge_signals</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="c1"># create a dag and workflow, etc.</span>
    <span class="o">...</span>
    <span class="k">with</span> <span class="n">SGESignalHandler</span><span class="p">(</span><span class="n">workflow</span><span class="p">):</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="glossary.html" class="btn btn-neutral float-right" title="11. Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="faq.html" class="btn btn-neutral float-left" title="9. FAQ" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013 Erik Gafni

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>